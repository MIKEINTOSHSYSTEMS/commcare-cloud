- name: Remove old datadog apt key
  apt_key: id=382E94DE keyserver=keyserver.ubuntu.com state=absent
  tags:
    - datadog

- name: Add datadog apt key
  apt_key: id=F14F620E keyserver=keyserver.ubuntu.com state=present
  tags:
    - datadog

- name: Add datadog apt repo
  apt_repository: repo='deb http://apt.datadoghq.com/ stable main' state=present update_cache=yes
  tags:
    - datadog

- name: Install datadog agent
  apt: name=datadog-agent state=latest update_cache=yes cache_valid_time=7200
  tags:
    - datadog

- name: copy datadog conf
  template:
    group: dd-agent
    owner: dd-agent
    src: datadog.conf.j2
    dest: /etc/dd-agent/datadog.conf
  notify: restart datadog
  tags:
    - datadog

- name: Make sure datadog agent is started
  service: name=datadog-agent state=started
  tags:
    - datadog
    - after-reboot

- name: Pull java tracer
  become: true
  become_user: "{{ cchq_user }}"
  get_url:
    url: "https://dtdg.co/latest-java-tracer"
    dest: "{{ cchq_home }}/dd-java-agent.jar"
  when: "inventory_hostname in groups.formplayer"

- import_tasks: add_integrations.yml
  when: DATADOG_ENABLED

- import_tasks: remove_integrations.yml
