#!/bin/bash 

# Process to soft and hard kill old celery jobs.
#

HOURS=$1
MAX_MINUTES=`expr ${HOURS} \* 60 \* 60`

SIG_NAME=$2

PIDS=$(ps -eo comm,pid,etimes | awk '/celeryd:/ { if ( $4 > '"${MAX_MINUTES}"' ) { print $3 } }');

if [ "$PIDS" != "" ]; then
  for pid in ${PIDS}
  do
     #echo "kill -${SIG_NAME} ${pid}"
     kill -${SIG_NAME} ${pid}
  done
fi
