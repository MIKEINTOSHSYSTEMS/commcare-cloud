# Sets up a fresh environments directory
# Run using `ansible-playbook --connection=local bootstrap-env-config.yml --extra-vars "env_name=$env_name"`

- hosts: 127.0.0.1
  connection: local

  vars:
    install_config:
      - '{{env_name}}'
      - '{{site_host}}'
      - '{{server_inventory_name}}'
      - '{{server_host_name}}'
      - '{{ssh_public_key}}'
      - '{{ssh_username}}'
    config_is_not_valid: '{{"" in install_config}}'
    envs_path: "{{ ansible_env.HOME }}/environments"
    env_path: "{{envs_path}}/{{ env_name }}"
  tasks:
    - debug:
        msg: "Invalid installation configuration: {{install_config}}. Please define all the variables in your install-config.yml file."
      when: config_is_not_valid
    - meta: end_play
      when: config_is_not_valid
    - name: Create environments directory
      file: path={{env_path}} state=directory
    - name: Create env's users directory
      file: path={{envs_path}}/_users state=directory
    - name: Create ssh-public-keys directory
      file: path={{envs_path}}/_authorized_keys state=directory
    - name: Copy templated env files
      template:
        src: "./sample-environment/{{item}}.j2"
        dest: "{{env_path}}/{{item}}"
      with_items:
        - "app-processes.yml"
        - "inventory.ini"
        - "meta.yml"
        - "proxy.yml"
        - "public.yml"
        - "vault.yml"
    - name: Copy non-templated env files
      ansible.builtin.copy:
        src: "./sample-environment/{{item}}"
        dest: "{{env_path}}/{{item}}"
      with_items:
        - "fab-settings.yml"
        - "known_hosts"
        - "postgresql.yml"
    - name: Create SSH public key file for the given user
      lineinfile:
        dest: "{{envs_path}}/_authorized_keys/{{ssh_username}}.pub"
        line: "{{ssh_public_key}}"
        create: yes
    - name: Copy _users dir
      template:
        src: "./sample-environment/_users/admins.yml.j2"
        dest: "{{envs_path}}/_users/admins.yml"
    - name: Configure commcare-cloud with  "manage-commcare-cloud configure --quiet"
      command: manage-commcare-cloud configure --quiet
      environment:
        COMMCARE_CLOUD_ENVIRONMENTS: "{{envs_path}}"
    - name: Add ~/.commcare-cloud/load_config.sh to ~/.profile
      lineinfile:
        dest: "{{ ansible_env.HOME }}/.profile"
        line: "source ~/.commcare-cloud/load_config.sh"
        create: yes

